#include <stdio.h>
#include <stdlib.h>



const int popBack=1;  // Delete last N bytes.
const char append[]=
{
0x56,0xC6,0x05,0x83,0x82,0x1A,0x00,0xC3,0xC6,0x05,0x38,0x82,0x1A,0x00,0xC3,0x66,  // 00
0xC7,0x05,0x98,0x80,0x1A,0x00,0x33,0xDB,0x66,0xC7,0x05,0x5A,0x81,0x1A,0x00,0x33,  // 01
0xDB,0xBE,0x40,0x80,0x1A,0x00,0xE8,0x9F,0x00,0x00,0x00,0xBE,0xAE,0x80,0x1A,0x00,  // 02
0xE8,0x95,0x00,0x00,0x00,0xBE,0x00,0x81,0x1A,0x00,0xE8,0x8B,0x00,0x00,0x00,0xBE,  // 03
0x70,0x81,0x1A,0x00,0xE8,0x81,0x00,0x00,0x00,0xBE,0xB2,0x81,0x1A,0x00,0xC7,0x06,  // 04
0x66,0xBB,0x3A,0xC4,0xC7,0x46,0x04,0x2E,0xFF,0x15,0xCC,0xC7,0x46,0x08,0x5F,0x1A,  // 05
0x00,0x66,0xC7,0x46,0x0C,0xB8,0xC0,0x55,0x33,0xC7,0x46,0x10,0xC9,0xCD,0x93,0x2E,  // 06
0xC7,0x46,0x14,0xFF,0x15,0xD0,0x5F,0xC7,0x46,0x18,0x1A,0x00,0xC3,0x90,0xBE,0xF4,  // 07
0x81,0x1A,0x00,0xC7,0x06,0x66,0xBB,0x3A,0xC4,0xC7,0x46,0x04,0x2E,0xFF,0x15,0xCC,  // 08
0xC7,0x46,0x08,0x5F,0x1A,0x00,0x66,0xC7,0x46,0x0C,0xB8,0xC0,0x56,0x33,0xC7,0x46,  // 09
0x10,0xC9,0xCD,0x93,0x2E,0xC7,0x46,0x14,0xFF,0x15,0xD0,0x5F,0xC7,0x46,0x18,0x1A,  // 0A
0x00,0xC3,0x90,0xC6,0x05,0x68,0x73,0x1A,0x00,0x2B,0xBE,0xAF,0x81,0x1A,0x00,0x66,  // 0B
0xC7,0x06,0x90,0x90,0xC6,0x46,0x02,0x90,0x5E,0xC3,0xC7,0x06,0x66,0xBB,0x3A,0xC4,  // 0C
0xC7,0x46,0x04,0x2E,0xFF,0x15,0xCC,0xC7,0x46,0x08,0x5F,0x1A,0x00,0x66,0xC7,0x46,  // 0D
0x0C,0xB8,0xC0,0x52,0x33,0xC7,0x46,0x10,0xC9,0xCD,0x93,0x66,0xC7,0x46,0x14,0xB8,  // 0E
0xC0,0x72,0x66,0xC7,0x46,0x18,0x8B,0x1E,0x66,0x8B,0xC7,0x46,0x1C,0x4E,0x02,0x66,  // 0F
0x8B,0xC7,0x46,0x20,0x56,0x04,0xCD,0x93,0xC7,0x46,0x24,0x2E,0xFF,0x15,0xD0,0xC7,  // 10
0x46,0x28,0x5F,0x1A,0x00,0xC3,0xC3,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,  // 11
0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,  // 12
0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,  // 13
0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,  // 14
0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,  // 15
0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,  // 16
0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,  // 17
0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,  // 18
0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,  // 19
0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,  // 1A
0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,  // 1B
0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,  // 1C
0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,  // 1D
0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,  // 1E
0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,  // 1F
0xC3
};

/* Fountain of NOPs
0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,  // 00
0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,  // 01
0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,  // 02
0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,  // 03
0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,  // 04
0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,  // 05
0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,  // 06
0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,  // 07
0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,  // 08
0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,  // 09
0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,  // 0A
0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,  // 0B
0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,  // 0C
0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,  // 0D
0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,  // 0E
0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,  // 0F
0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,  // 10
0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,  // 11
0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,  // 12
0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,  // 13
0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,  // 14
0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,  // 15
0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,  // 16
0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,  // 17
0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,  // 18
0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,  // 19
0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,  // 1A
0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,  // 1B
0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,  // 1C
0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,  // 1D
0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,  // 1E
0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,  // 1F
*/


const char patchExpandBackFrom[]=
{
//000C:000694E4 BE02960600               MOV	ESI,00069602 -> Increase by 200H
//000C:000694E9 B910010000               MOV	ECX,00000110 -> Increase by 200H
//000C:000694EE F2A4                     REPNE MOVSB 
//000C:000694F0 47                       INC	EDI
//000C:000694F1 FFE7                     JMP	EDI
0xBE,0x02,0x96,0x06,0x00,
0xB9,0x10,0x01,0x00,0x00,
0xF2,0xA4,
0x47,
0xFF,0xE7
};

const char patchExpandBackTo[]=
{
0xBE,0x02,0x98,0x06,0x00,
0xB9,0x10,0x03,0x00,0x00,
0xF2,0xA4,
0x47,
0xFF,0xE7
};



int ApplyPatch(
    int nByte,unsigned char byteData[],
    int nPatchFrom,const unsigned char patchFrom[],
    int nPatchTo,const unsigned char patchTo[])
{
	int nOccurrence=0;
	for(int i=0; i<nByte; ++i)
	{
		int found=1;
		for(int j=0; j<nPatchFrom && i+j<nByte; ++j)
		{
			if(byteData[i+j]!=patchFrom[j])
			{
				found=0;
				break;
			}
		}
		if(0!=found)
		{
			printf("Apply Patch at %08x\n",i);
			for(int j=0; j<nPatchTo; ++j)
			{
				byteData[i+j]=patchTo[j];
			}
			++nOccurrence;
		}
	}
	return nOccurrence;
}

unsigned int ReadInt(const unsigned char *ptr)
{
	return  ((unsigned int)ptr[3]<<24) |
	        ((unsigned int)ptr[2]<<16) |
	        ((unsigned int)ptr[1]<< 8) |
	        ((unsigned int)ptr[0]    );
}

void WriteInt(unsigned char *ptr,unsigned int value)
{
	ptr[0]=( value     &255);
	ptr[1]=((value>> 8)&255);
	ptr[2]=((value>>16)&255);
	ptr[3]=((value>>24)&255);
}

unsigned int ReadWord(const unsigned char *ptr)
{
	return  ((unsigned int)ptr[1]<< 8) |
	        ((unsigned int)ptr[0]    );
}

void WriteWord(unsigned char *ptr,unsigned int value)
{
	ptr[0]=( value     &255);
	ptr[1]=((value>> 8)&255);
}

int main(int ac,char *av[])
{
	printf("This patch is for lasint.exp -> lasintp.exp\n");


	int nByte=0,nByteRead=0,nByteWrite=0,nByteWritten=0;
	unsigned char *byteData=NULL;
	FILE *fp;

	fp=fopen("lasint.exp","rb");
	if(NULL==fp)
	{
		fprintf(stderr,"Cannot Open Input File!\n");
		return 1;
	}

	fseek(fp,0,SEEK_END);
	nByte=ftell(fp);
	fseek(fp,0,SEEK_SET);

	byteData=(unsigned char *)malloc(nByte+sizeof(append));
	if(NULL==byteData)
	{
		fprintf(stderr,"Not Enough Memory Space!\n");
		return 1;
	}
	nByteRead=fread(byteData,1,nByte,fp);
	fclose(fp);

	if(nByteRead!=nByte)
	{
		fprintf(stderr,"File Read Error!\n");
		return 1;
	}

	nByteWrite=nByteRead+sizeof(append)-popBack;

	if(nByteWrite!=nByteRead)
	{
		if('P'==byteData[0] && '3'==byteData[1])
		{
			// Thanks Nabe for free386 documentations!
			//+2A d	load image size
			unsigned int binSize;

			binSize=ReadInt(byteData+0x2A);
			printf("Current Load Image Size at 0x2A=%08x\n",binSize);

			binSize+=sizeof(append);
			binSize-=popBack;
			WriteInt(byteData+0x2A,binSize);

			printf("New Load Image Size at 0x2A=%08x\n",binSize);



			//+74 d	load image size
			binSize=ReadInt(byteData+0x74);
			printf("Current Load Image Size at 0x74=%08x\n",binSize);

			binSize+=sizeof(append);
			binSize-=popBack;
			WriteInt(byteData+0x74,binSize);

			printf("New Load Image Size at 0x74=%08x\n",binSize);
		}
		else if('M'==byteData[0] && 'P'==byteData[1])
		{
			WriteWord(byteData+2,(nByteWrite&511));
			WriteWord(byteData+4,(nByteWrite+511)/512);
		}
		else
		{
			fprintf(stderr,"No resizing in non-P3 executable.\n");
			return 1;
		}
	}



	for(int i=0; i<sizeof(append); ++i)
	{
		byteData[nByteRead-popBack+i]=append[i];
	}

	if(0==ApplyPatch(nByte,byteData,sizeof(patchExpandBackFrom),patchExpandBackFrom,sizeof(patchExpandBackTo),patchExpandBackTo))
	{
		fprintf(stderr,"Source Pattern ExpandBack Not Found!\n");
		return 1;
	}



	fp=fopen("lasintp.exp","wb");;
	if(NULL==fp)
	{
		fprintf(stderr,"Cannot Open Input File!\n");
		return 1;
	}

	nByteWritten=fwrite(byteData,1,nByteWrite,fp);
	if(nByteWritten!=nByteWrite)
	{
		fprintf(stderr,"File Write Error!\n");
		return 1;
	}
	fclose(fp);

	printf("Patched!\n");
	return 0;
}
