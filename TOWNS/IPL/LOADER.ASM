						ASSUME	CS:CODE,DS:CODE


VERSION_STRING			EQU		"VERSION 20200922"

						.386p
CODE					SEGMENT	USE16

						INCLUDE		IODEF.ASM
						INCLUDE		DEF.ASM

MAIN					PROC
						JMP		REALMAIN
						DB		"RESCUE"
INCOMING_BX				DW		0
LOADER_BIOS_DEVICE_ID	DB		0
YSSCSICD_LOADED			DB		0
REALMAIN:
; Incoming BL:Device Type   1:HD  2:FD  8:CD
; Incoming BH:Unit Number
						CLI
						PUSH	CS
						POP		DS

						MOV		CS:[INCOMING_BX],BX
						AND		BH,0FH
						AND		BL,0FH
						CMP		BL,1
						JNE		@f
						OR		BH,0B0H
						JMP		DEVICE_ID_SET
@@:
						CMP		BL,2
						JNE		@f
						OR		BH,020H
						JMP		DEVICE_ID_SET

@@:
						XOR		BX,BX

DEVICE_ID_SET:
						MOV		CS:[LOADER_BIOS_DEVICE_ID],BH


						CALL	INITGRAPHICS
						CALL	VRAMMODE
						CALL	CLS

						MOV		AL,15
						CALL	COLOR

				; CALL	TSUGARU_DEBUG_BREAK

						CALL	DRAW_AOMORI

						MOV		AX,0101H
						CALL	LOCATE
						MOV		SI,OFFSET MESSAGE_LINE0
						CALL	PRINT_TALL

						MOV		AX,0102H
						CALL	LOCATE
						MOV		SI,OFFSET MESSAGE_LINE1
						CALL	PRINT_TALL

						MOV		AX,0103H
						CALL	LOCATE
						MOV		SI,OFFSET MESSAGE_LINE2
						CALL	PRINT_TALL


						CALL	BOOT_FROM_SCSI_CD

@@:
						JMP			@b

MAIN					ENDP

						INCLUDE		UTIL.ASM
						INCLUDE		DRAWFONT.ASM
						INCLUDE		MEMBANK.ASM
						INCLUDE		../SCSILIB/SCSIIO.ASM
						INCLUDE		SCSIUTIL.ASM
						INCLUDE		CDBOOT.ASM
						INCLUDE		LOADYSSC.ASM
						INCLUDE		GRAPHICS.ASM
						INCLUDE		../RESOURCE/AOMORI.ASM
						INCLUDE		TSUGARU.ASM

MESSAGE_LINE0			DB	"FM TOWNS RESCUE BOOT LOADER BY CAPTAINYS",0
MESSAGE_LINE1			DB	VERSION_STRING,0
MESSAGE_LINE2			DB	"http://www.ysflight.com",0

CODE					ENDS

						END		MAIN
